æˆ‘ç›®å‰æ¡ç”¨æ¯å€‹ backend æœ‰ç¨ç«‹ capacity unit çš„æ¦‚å¿µè¨­è¨ˆï¼Œä¹Ÿå°±æ˜¯å‰é¢æåŠçš„æ¯å€‹ api éƒ½æœ‰å®£å‘Šå¥½çš„ capacity unit, é€éè‡ªå·±å…§éƒ¨çš„ lock æ©Ÿåˆ¶æ§åˆ¶æ¥æ”¶è«‹æ±‚çš„æ•¸é‡, è¶…é capacity unit å‰‡æœƒå›è¦†429ã€‚æˆ‘é€™å€‹è¨­è¨ˆçš„å¥½è™•æ˜¯æ¯å€‹ backend çš„ compute unit (pod) éƒ½æ˜¯ç¨ç«‹è¨ˆç®—çš„ï¼Œç¼ºé»å°±æ˜¯ç•¶ è«‹æ±‚æ•¸é‡ä¸€å¤§ï¼Œå›è¦†429çš„æ©Ÿæœƒå°±å¤§ï¼Œæ‰€ä»¥æˆ‘åœ¨æ‰¾æœ‰æ²’é¡ä¼¼çš„æ©Ÿåˆ¶ï¼Œå¯ä»¥é€é ä¸Šä¸€æ£’çš„è§’è‰²ï¼Œæ§åˆ¶æ•´é«”çš„ capacity unit ... æˆ–è€…åœ¨å‰é¢è¨è«–çš„ç¨±ç‚ºæ¬Šé‡


---

ä½ çš„è¨­è¨ˆå¾ˆæœ‰å½ˆæ€§ï¼Œèƒ½å¤ ç¢ºä¿æ¯å€‹ backend çš„ `compute unit (pod)` ç¨ç«‹ç®¡ç†è‡ªèº«çš„ `capacity unit`ï¼Œä½†ç•¶æµé‡æš´å¢æ™‚ï¼Œå–®å€‹ backend ç„¡æ³•è² æ“”ï¼Œå°±æœƒå¤§é‡å›æ‡‰ `429 Too Many Requests`ï¼Œé€ æˆæ•´é«”è«‹æ±‚è™•ç†ç‡ä¸‹é™ã€‚å› æ­¤ï¼Œä½ å¸Œæœ›æœ‰**ä¸Šå±¤çš„è§’è‰²ä¾†å”èª¿æ‰€æœ‰ backend çš„ capacity unitï¼Œä½¿æ•´é«”è³‡æºåˆ©ç”¨ç‡æœ€ä½³åŒ–**ã€‚  

é€™æ¨£çš„æ¦‚å¿µé¡ä¼¼æ–¼**å…¨åŸŸæ’éšŠæ©Ÿåˆ¶ï¼ˆGlobal Admission Controlï¼‰** æˆ– **é›†ä¸­å¼ Token Bucket**ï¼Œè®“ Gateway æˆ–è² è¼‰å‡è¡¡å™¨ä¾†å”èª¿ backend çš„ `capacity unit`ï¼Œè€Œä¸æ˜¯è®“ backend å–®ç¨æ±ºå®šã€‚

---

## **æœ€ä½³è§£æ³•æ–¹å‘**
æ ¹æ“šä½ çš„éœ€æ±‚ï¼Œæœ‰å¹¾ç¨®å¯è¡Œçš„æ–¹æ¡ˆï¼š

| è§£æ³• | æ ¸å¿ƒæ¦‚å¿µ | å„ªé» | ç¼ºé» |
|------|------|------|------|
| **é›†ä¸­å¼ Token Bucket (Redis)** | ç”¨ Redis ä¾†å…¨åŸŸç®¡ç† `capacity unit` | å…¨åŸŸé™æµï¼Œé¿å…æŸå€‹ backend éè¼‰ | éœ€è¦é¡å¤– Redis ä¾†å…±äº«ç‹€æ…‹ |
| **åŸºæ–¼ Gateway (Nginx/Kong/APISIX)** | è®“ API Gateway æ§åˆ¶ç¸½é«”è² è¼‰ | ç„¡é ˆ backend è‡ªå·±é™æµï¼Œæµé‡æ›´å¹³è¡¡ | éœ€è¦ API Gatewayï¼Œä¸”ç­–ç•¥è¼ƒå›ºå®š |
| **åŸºæ–¼ MQ (RabbitMQ/Kafka)** | æ‰€æœ‰è«‹æ±‚å…ˆé€²å…¥éšŠåˆ—ï¼Œbackend æŒ‰ `capacity unit` å–ç”¨ | ç²¾ç¢ºæ§åˆ¶æµé‡ï¼Œé¿å…æ‹’çµ•è«‹æ±‚ | å¢åŠ å»¶é²ï¼Œé©åˆéåŒæ­¥ API |
| **è‡ªè¨‚ Middleware** | ç”¨ service ä¾†å‹•æ…‹åˆ†é… backend è² è¼‰ | é«˜åº¦è‡ªè¨‚åŒ–ï¼Œå¯æ”¯æ´ä¸åŒæ¬Šé‡ | éœ€è¦é–‹ç™¼é¡å¤–çš„æœå‹™ |

---

### **æ–¹æ¡ˆ 1ï¼šRedis Token Bucket (æ¨è–¦)**
#### **æ ¸å¿ƒæ¦‚å¿µ**
é€é **Redis** ä¾†å…¨åŸŸè¿½è¹¤ `capacity unit`ï¼Œç¢ºä¿ backend ä¸æœƒè¶…éæ•´é«”ç³»çµ±çš„ `capacity unit`ï¼Œé¿å…æš´å¢ `429`ã€‚

#### **å¯¦ä½œæ–¹å¼**
1. **Redis å­˜å„²å…¨åŸŸ Token**ï¼š
   - æ¯å€‹ API **æ ¹æ“šæ¬Šé‡å–å¾— token**ï¼Œå¦‚æœè¶…éç¸½é‡å‰‡æ‹’çµ•è«‹æ±‚ã€‚

   ```lua
   -- Redis Lua Script (atomic operation)
   local key = KEYS[1]
   local now = tonumber(ARGV[1])
   local requested_tokens = tonumber(ARGV[2])
   local capacity = tonumber(ARGV[3])

   -- å–å¾—ç›®å‰ token æ•¸é‡
   local current_tokens = tonumber(redis.call("GET", key) or capacity)

   if current_tokens >= requested_tokens then
       -- æ‰£é™¤ token
       redis.call("DECRBY", key, requested_tokens)
       return 1  -- å…è¨±è«‹æ±‚
   else
       return 0  -- è¶…é capacity
   end
   ```

2. **API Gateway (Nginx / Kong) å…ˆå‘ Redis å–å¾— Token**ï¼š
   - API A éœ€è¦ `1` unitï¼ŒAPI B éœ€è¦ `2` unitsï¼Œä¾æ­¤é¡æ¨ï¼š
   - **è«‹æ±‚æµé‡å¤§æ™‚ï¼Œå„ªå…ˆçµ¦ä½æ¬Šé‡çš„ APIï¼Œé¿å…é«˜æ¬Šé‡ API æ¶å…‰æ‰€æœ‰è³‡æº**ã€‚

   ```nginx
   location /api/ {
       set $api_weight 1;  # ä¾ API è¨­å®šæ¬Šé‡
       set $redis_key "global_capacity";
       redis2_query GET $redis_key;
       if ($redis2_value < $api_weight) {
           return 429; # ç„¡è¶³å¤  tokenï¼Œæ‹’çµ•è«‹æ±‚
       }
   }
   ```

3. **å¾Œå°å®šæœŸè£œå…… Token**ï¼š
   - é€é `cron job` å®šæœŸè£œå…… `capacity unit`ï¼Œä¾‹å¦‚**æ¯ç§’è£œå…… 10 å€‹ token**ã€‚

   ```lua
   redis.call("INCRBY", "global_capacity", 10)
   ```

#### **å„ªé»**
âœ… **å…¨åŸŸé™æµ**ï¼Œç¢ºä¿ backend ä¸æœƒæš´å¢ `429`  
âœ… **æ”¯æ´å‹•æ…‹èª¿æ•´**ï¼ˆå¯ä»¥æ ¹æ“š backend æ•ˆèƒ½å³æ™‚æ”¹è®Š token ç™¼æ”¾é€Ÿç‡ï¼‰  
âœ… **ä½å»¶é²**ï¼Œæ¯” MQ æ¨¡å‹å¿«  

#### **ç¼ºé»**
âŒ éœ€è¦ Redisï¼Œä¸¦ä¸” Redis å¯èƒ½æˆç‚ºç“¶é ¸  
âŒ éœ€è¦é¡å¤–é–‹ç™¼ API Gateway çš„ Redis äº’å‹•æ©Ÿåˆ¶  

---

### **æ–¹æ¡ˆ 2ï¼šåŸºæ–¼ API Gateway (Kong / APISIX / Envoy)**
#### **æ ¸å¿ƒæ¦‚å¿µ**
è®“ API Gateway **ç›´æ¥æ§ç®¡ API å‘¼å«æ•¸é‡**ï¼Œè€Œä¸æ˜¯ backend è‡ªå·±æ§ç®¡ã€‚

#### **å¯¦ä½œæ–¹å¼**
1. **åœ¨ Kong è¨­å®š API å±¤ç´šçš„æ¬Šé‡èˆ‡é™åˆ¶**
   - API A æ¬Šé‡ 1ï¼ŒAPI B æ¬Šé‡ 2ï¼ŒAPI C æ¬Šé‡ 3ï¼š
   ```yaml
   plugins:
     - name: rate-limiting-advanced
       config:
         limit_by: consumer
         policy: local
         minute: 50  # å…¨ç³»çµ± 50 å€‹ requests/min
         weight:
           a: 1
           b: 2
           c: 3
   ```

2. **ç•¶æŸå€‹ API è¶…éè² è¼‰æ™‚ï¼Œè‡ªå‹•æ‹’çµ•æˆ–èª¿æ•´æµé‡**
   - `rate-limiting` æœƒæ ¹æ“š API æ¬Šé‡ä¾†è¨ˆç®— `capacity unit`ï¼Œè€Œä¸æ˜¯è®“ backend è‡ªå·±æ‹’çµ•è«‹æ±‚ã€‚

#### **å„ªé»**
âœ… **å…¨åŸŸæ§åˆ¶ API æ•´é«”è² è¼‰**  
âœ… **ç„¡é ˆ backend è‡ªå·±ç®¡ç†é™æµ**  
âœ… **æ”¯æ´ Kong / APISIXï¼Œå®¹æ˜“å¯¦ä½œ**  

#### **ç¼ºé»**
âŒ **æ¯å€‹ API è¢«æ‹’çµ•çš„æ©Ÿç‡è¼ƒé«˜ï¼Œå½±éŸ¿ UX**  
âŒ **ç„¡æ³•å‹•æ…‹æ ¹æ“š backend è² è¼‰åšæ›´ç´°ç·»çš„èª¿æ•´**  

---

### **æ–¹æ¡ˆ 3ï¼šåŸºæ–¼ MQ (RabbitMQ/Kafka)**
#### **æ ¸å¿ƒæ¦‚å¿µ**
æ‰€æœ‰è«‹æ±‚**å…ˆé€²å…¥ä½‡åˆ—ï¼ˆMQï¼‰ï¼ŒBackend ä¾è‡ªèº« `capacity unit` å–ç”¨**ï¼Œé¿å…æº¢å‡ºã€‚

#### **å¯¦ä½œæ–¹å¼**
1. **è«‹æ±‚é€²å…¥ RabbitMQ éšŠåˆ—**
   - API Gateway å°‡è«‹æ±‚è½‰ç™¼åˆ° MQï¼Œè€Œéç›´æ¥å‚³çµ¦ backendï¼š
   ```yaml
   exchanges:
     - name: request_exchange
       type: direct
   queues:
     - name: backend_queue
       bindings:
         - exchange: request_exchange
           routing_key: request
   ```

2. **Backend ä¾è‡ªèº« `capacity unit` å–ç”¨è«‹æ±‚**
   - æ¯å€‹ backend åœ¨å•Ÿå‹•æ™‚ï¼Œè¨­å®šè‡ªå·±çš„ `capacity unit`ï¼š
   ```java
   channel.basicQos(20); // æ¯æ¬¡æœ€å¤šè™•ç† 20 å€‹ request
   ```

3. **MQ ç¢ºä¿ä¸è¶…é Backend æ‰¿è¼‰é‡**
   - ç•¶ backend å¿™ç¢Œæ™‚ï¼Œè«‹æ±‚æœƒè‡ªå‹•ç­‰å¾…ï¼Œä¸æœƒç”¢ç”Ÿ `429 Too Many Requests`ã€‚

#### **å„ªé»**
âœ… **è«‹æ±‚ä¸æœƒä¸Ÿå¤±**ï¼ˆå³ä½¿ backend å¿™ç¢Œï¼Œä¹Ÿä¸æœƒ 429ï¼‰  
âœ… **æ”¯æ´é«˜ä½µç™¼**ï¼Œé©åˆç•°æ­¥è™•ç†  

#### **ç¼ºé»**
âŒ **å¼•å…¥é¡å¤–çš„å»¶é²**ï¼ˆè«‹æ±‚éœ€è¦æ’éšŠï¼‰  
âŒ **é©åˆéåŒæ­¥ APIï¼Œå°åŒæ­¥è«‹æ±‚ä¸å‹å¥½**  

---

## **çµè«–**
| è§£æ³• | é©ç”¨å ´æ™¯ |
|------|------|
| **Redis Token Bucket** âœ…ï¼ˆæ¨è–¦ï¼‰| ä½å»¶é²ï¼Œé«˜æ•ˆèƒ½ï¼Œé©åˆ API Gateway æ§åˆ¶å…¨åŸŸæµé‡ |
| **API Gateway é™æµ** | é©åˆ Kong/APISIX ç®¡ç† API æµé‡ï¼Œä½†è¼ƒé›£å„ªåŒ– backend è² è¼‰ |
| **MQ æ’éšŠæ©Ÿåˆ¶** | é©åˆéåŒæ­¥ APIï¼Œèƒ½é¿å… `429`ï¼Œä½†æœ‰é¡å¤–å»¶é² |
| **è‡ªè¨‚ Middleware** | é©åˆå®Œå…¨å®¢è£½åŒ–éœ€æ±‚ï¼Œä½†é–‹ç™¼æˆæœ¬é«˜ |

ä½ çš„æ¶æ§‹ç›®å‰æ˜¯**åŒæ­¥è«‹æ±‚**ï¼Œæ‰€ä»¥æˆ‘æ¨è–¦ **Redis Token Bucket**ï¼Œå¯ä»¥è®“ API Gateway å‹•æ…‹èª¿æ§ backend çš„æµé‡ï¼Œç¢ºä¿ `429` ç™¼ç”Ÿç‡æœ€ä½ã€‚

ä½ è¦ºå¾—é€™æ¨£çš„è¨­è¨ˆç¬¦åˆä½ çš„éœ€æ±‚å—ï¼Ÿå¦‚æœéœ€è¦æ›´ç´°ç¯€çš„ä»£ç¢¼ï¼Œæˆ‘å¯ä»¥å¹«ä½ è£œå……ï¼ ğŸš€