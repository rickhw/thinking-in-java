# 2D RPG 遊戲設計規格文件

## 專案概述

這是一個基於 Java Swing 開發的 2D RPG 遊戲，實現了基本的遊戲循環、角色移動、世界地圖渲染和碰撞檢測系統。遊戲採用瓦片地圖系統，支援角色在大型世界中自由探索，並具備完整的碰撞檢測機制。

## 系統架構

### 核心架構模式
- **MVC 架構**: 遊戲邏輯、渲染和輸入處理分離
- **組件化設計**: 各功能模組獨立，便於維護和擴展
- **事件驅動**: 基於鍵盤輸入和遊戲循環的事件處理

### 主要組件關係
```
Main
├── GamePanel (遊戲主控制器)
│   ├── Player (玩家實體)
│   ├── TileManager (地圖管理)
│   ├── CollisionChecker (碰撞檢測)
│   └── KeyHandler (輸入處理)
└── Config (全域配置)
```

## 詳細設計

### 1. 遊戲配置系統 (Config.java)

**職責**: 管理所有遊戲相關的常數和配置參數

**核心配置**:
- **螢幕設定**: 16x12 瓦片的可視區域 (768x576 像素)
- **瓦片系統**: 16x16 原始瓦片，3倍縮放至 48x48
- **世界設定**: 50x50 瓦片的大型世界地圖
- **效能設定**: 60 FPS 遊戲循環

### 2. 遊戲主控制器 (GamePanel.java)

**職責**: 遊戲的核心控制器，管理遊戲循環和組件協調

**核心功能**:
- **遊戲循環**: 使用 delta time 實現穩定的 60 FPS
- **更新循環**: 協調所有遊戲物件的狀態更新
- **渲染管道**: 按順序渲染地圖和遊戲物件
- **組件管理**: 初始化和管理所有遊戲組件

**遊戲循環實現**:
```java
// 使用 nano time 精確控制幀率
double drawInterval = 1000000000 / FPS;
// Delta time 累積確保穩定更新
while (gameThread != null) {
    // 更新遊戲狀態
    update();
    // 重繪畫面
    repaint();
}
```

### 3. 實體系統

#### 3.1 基礎實體類 (Entity.java)

**設計模式**: 抽象基類模式

**核心屬性**:
- **位置系統**: 世界座標 (worldX, worldY)
- **動畫系統**: 8 方向精靈圖和動畫計數器
- **碰撞系統**: 碰撞區域 (Rectangle) 和碰撞狀態

#### 3.2 玩家實體 (Player.java)

**職責**: 處理玩家角色的所有行為和狀態

**核心功能**:
- **相機系統**: 玩家固定在螢幕中央，世界相對移動
- **動畫系統**: 基於移動方向的精靈動畫切換
- **移動系統**: 整合碰撞檢測的安全移動
- **輸入響應**: 即時響應 WASD 鍵盤輸入

**相機實現**:
```java
// 玩家在螢幕中央的固定位置
screenX = SCREEN_WIDTH / 2 - (TILE_SIZE / 2);
screenY = SCREEN_HEIGHT / 2 - (TILE_SIZE / 2);
```

#### 3.3 方向系統 (Direction.java)

**設計**: 列舉類型確保類型安全
```java
public enum Direction {
    UP, DOWN, LEFT, RIGHT
}
```

### 4. 地圖系統

#### 4.1 瓦片類 (Tile.java)

**職責**: 表示單一地圖瓦片的屬性

**核心屬性**:
- **視覺**: BufferedImage 圖像資源
- **物理**: boolean collision 碰撞屬性

#### 4.2 地圖管理器 (TileManager.java)

**職責**: 管理整個遊戲世界的地圖系統

**核心功能**:
- **資源管理**: 載入和管理瓦片圖像資源
- **地圖載入**: 從文字檔案載入地圖佈局
- **視錐剔除**: 只渲染可視區域內的瓦片
- **相機轉換**: 世界座標到螢幕座標的轉換

**瓦片類型定義**:
- **0**: 草地 (可通行)
- **1**: 牆壁 (不可通行)
- **2**: 水域 (不可通行)
- **3**: 土地 (可通行)
- **4**: 樹木 (不可通行)
- **5**: 沙地 (可通行)

**視錐剔除算法**:
```java
// 只渲染在相機視野內的瓦片
if (worldX + TILE_SIZE > player.worldX - player.screenX &&
    worldX - TILE_SIZE < player.worldX + player.screenX &&
    worldY + TILE_SIZE > player.worldY - player.screenY &&
    worldY - TILE_SIZE < player.worldY + player.screenY) {
    // 渲染瓦片
}
```

### 5. 碰撞檢測系統 (CollisionChecker.java)

**職責**: 處理所有遊戲物件的碰撞檢測

**核心算法**:
1. **邊界計算**: 計算實體的碰撞邊界
2. **瓦片映射**: 將世界座標轉換為瓦片索引
3. **預測檢測**: 檢查移動後的位置是否會碰撞
4. **邊界檢查**: 防止移動超出世界邊界

**碰撞檢測流程**:
```java
// 1. 計算實體的碰撞邊界
int entityLeftWorldX = entity.worldX + entity.solidArea.x;
int entityRightWorldX = entity.worldX + entity.solidArea.x + entity.solidArea.width;

// 2. 轉換為瓦片座標
int entityLeftCol = entityLeftWorldX / TILE_SIZE;
int entityRightCol = entityRightWorldX / TILE_SIZE;

// 3. 根據移動方向檢查目標瓦片
switch (entity.direction) {
    case UP:
        // 檢查上方瓦片是否可通行
        break;
    // ... 其他方向
}
```

### 6. 輸入系統 (KeyHandler.java)

**職責**: 處理鍵盤輸入事件

**設計模式**: 觀察者模式 (KeyListener)

**支援按鍵**:
- **W**: 向上移動
- **S**: 向下移動
- **A**: 向左移動
- **D**: 向右移動

**狀態管理**: 使用布林變數追蹤按鍵狀態，支援多鍵同時按下

## 技術特點

### 1. 效能優化
- **視錐剔除**: 只渲染可見瓦片，大幅提升渲染效能
- **精確時間控制**: 使用 nanoTime 實現穩定的遊戲循環
- **資源預載**: 遊戲啟動時預載所有圖像資源

### 2. 可擴展性
- **抽象實體系統**: 便於添加新的遊戲物件類型
- **組件化架構**: 各系統獨立，便於功能擴展
- **配置集中化**: 所有遊戲參數集中管理

### 3. 穩定性
- **邊界檢查**: 防止越界存取和移動
- **異常處理**: 資源載入和檔案操作的異常處理
- **狀態一致性**: 確保遊戲狀態的一致性

## 資源結構

### 圖像資源
```
assets/
├── player/          # 玩家精靈圖 (8個方向動畫)
│   ├── boy_up_1.png
│   ├── boy_up_2.png
│   └── ...
├── tiles/           # 地圖瓦片圖像
│   ├── grass.png
│   ├── wall.png
│   ├── water.png
│   ├── earth.png
│   ├── tree.png
│   └── sand.png
└── maps/            # 地圖資料檔案
    ├── world01.txt
    ├── worldV2.txt
    └── ...
```

### 地圖格式
- **格式**: 純文字檔案，空格分隔的數字
- **結構**: 50x50 的二維陣列
- **數值**: 對應瓦片類型的索引值

## 未來擴展方向

### 短期目標
1. **物品系統**: 實現可撿拾的物品和道具
2. **NPC 系統**: 添加非玩家角色和對話系統
3. **音效系統**: 整合背景音樂和音效

### 長期目標
1. **戰鬥系統**: 實現回合制或即時戰鬥
2. **任務系統**: 添加任務和劇情系統
3. **存檔系統**: 實現遊戲進度保存和載入

## 開發注意事項

### 程式碼品質
- 遵循 Java 命名慣例
- 適當的註解和文件
- 異常處理和錯誤檢查

### 效能考量
- 避免在遊戲循環中創建新物件
- 合理使用靜態資源
- 監控記憶體使用情況

### 可維護性
- 保持類別職責單一
- 使用適當的設計模式
- 定期重構和優化程式碼

---

*此文件記錄了 day07_kiro 專案的完整設計架構，為後續開發和維護提供參考依據。*